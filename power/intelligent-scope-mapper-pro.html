<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligent Scope Mapper PRO - NaviaFreight</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 32px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .header .subtitle {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 12px;
        }

        .header .pro-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 520px 1fr;
            gap: 24px;
        }

        /* Input Panel */
        .input-panel {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .panel-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .scope-input {
            width: 100%;
            min-height: 400px;
            padding: 16px;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            margin-bottom: 16px;
        }

        .scope-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: #f8fafc;
        }

        .file-upload-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload-zone:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }

        .file-upload-zone.dragover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .upload-text {
            color: #64748b;
            font-size: 14px;
        }

        /* Buttons */
        .btn-primary {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .quick-templates {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }

        .template-label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .template-btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .template-btn:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }

        .template-btn.purple {
            border-color: #8b5cf6;
            color: #8b5cf6;
        }

        .template-btn.purple:hover {
            background: #f5f3ff;
        }

        .template-btn.green {
            border-color: #10b981;
            color: #10b981;
        }

        .template-btn.green:hover {
            background: #f0fdf4;
        }

        .template-btn.orange {
            border-color: #f59e0b;
            color: #f59e0b;
        }

        .template-btn.orange:hover {
            background: #fffbeb;
        }

        /* Power Automate Section - NEW */
        .power-automate-section {
            margin-top: 16px;
            padding: 16px;
            background: linear-gradient(135deg, #0078d4 0%, #0063b1 100%);
            border-radius: 8px;
            color: white;
        }

        .power-automate-section h3 {
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .power-automate-section p {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 12px;
        }

        .pa-export-btn {
            width: 100%;
            padding: 10px;
            background: white;
            color: #0078d4;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pa-export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255,255,255,0.3);
        }

        .pa-export-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Analysis Panel */
        .analysis-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .section-header {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .analysis-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s;
        }

        .analysis-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }

        .analysis-card.warning {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .analysis-card.error {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .card-label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .card-value {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
        }

        /* Flow Columns */
        .flow-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-top: 24px;
        }

        .flow-column {
            background: white;
            border-radius: 8px;
            padding: 16px;
            border: 2px solid #e2e8f0;
        }

        .column-header {
            font-size: 14px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 16px;
            padding: 8px;
            background: #f8fafc;
            border-radius: 6px;
            text-align: center;
        }

        .flow-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .flow-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-color: #3b82f6;
        }

        .flow-card.incomplete {
            border-left: 4px solid #f59e0b;
            background: #fffbeb;
        }

        .flow-step-number {
            display: inline-block;
            width: 24px;
            height: 24px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-size: 12px;
            font-weight: 700;
            margin-right: 8px;
        }

        .flow-title {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 6px;
            cursor: pointer;
        }

        .flow-meta {
            font-size: 11px;
            color: #64748b;
            margin-bottom: 6px;
        }

        .flow-notes {
            font-size: 11px;
            color: #64748b;
            padding-top: 6px;
            border-top: 1px dashed #e2e8f0;
            margin-top: 6px;
            cursor: pointer;
        }

        /* Export Panel */
        .export-panel {
            display: none;
            gap: 12px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .export-btn {
            flex: 1;
            min-width: 200px;
            padding: 12px 20px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-btn:hover {
            border-color: #3b82f6;
            background: #f8fafc;
            transform: translateY(-2px);
        }

        /* Missing Info Alert */
        .missing-info {
            background: #fef2f2;
            border: 2px solid #fecaca;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .missing-info h4 {
            color: #dc2626;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .missing-info ul {
            padding-left: 20px;
        }

        .missing-info li {
            color: #991b1b;
            font-size: 13px;
            margin-bottom: 4px;
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* NEW: Power Automate Flow Preview */
        .pa-flow-preview {
            background: #f8fafc;
            border: 2px solid #0078d4;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            display: none;
        }

        .pa-flow-preview h3 {
            color: #0078d4;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .pa-flow-steps {
            font-size: 12px;
            font-family: 'Courier New', monospace;
            color: #475569;
        }

        .pa-flow-step {
            padding: 8px;
            background: white;
            border-left: 3px solid #0078d4;
            margin-bottom: 6px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Intelligent Scope Mapper PRO</h1>
            <p class="subtitle">Upload integration scope docs ‚Üí Auto-generate workflow + Power Automate flows</p>
            <span class="pro-badge">‚ö° PRO: Power Automate Integration Enabled</span>
        </div>

        <div class="main-grid">
            <!-- Left Panel: Input -->
            <div class="input-panel">
                <div class="panel-title">üìù Scope Document Input</div>
                
                <div class="file-upload-zone" id="fileUploadZone">
                    <div class="upload-text">
                        üìÑ <strong>Drop .txt file here</strong><br>
                        <small>or click to browse</small>
                    </div>
                    <input type="file" id="fileInput" accept=".txt,.md" style="display: none;">
                </div>

                <textarea 
                    id="scopeInput" 
                    class="scope-input" 
                    placeholder="Paste your integration scope document here...

Example:
- Shopify store integration with BGI warehouse
- Real-time order webhooks
- Serial number tracking required
- ShipStation for shipping rates
- Inventory sync 3x daily
- Email parsing for support tickets
"></textarea>

                <button id="analyzeBtn" class="btn-primary" onclick="analyzeScope()">
                    üîç Analyze & Generate Flow
                </button>

                <div class="quick-templates">
                    <div class="template-label">‚ö° Quick Templates</div>
                    <button class="template-btn purple" onclick="loadShopifyNaviaTemplate()">
                        üì¶ Shopify ‚Üí NaviaFill ‚Üí BGI
                    </button>
                    <button class="template-btn green" onclick="loadMultiWarehouseTemplate()">
                        üåç Multi-Warehouse Fulfillment
                    </button>
                    <button class="template-btn orange" onclick="loadCrossBorderTemplate()">
                        ‚úàÔ∏è Cross-Border Compliance
                    </button>
                    <button class="template-btn" onclick="loadEmailBugTrackingTemplate()">
                        üìß Email Bug Tracking (Raft.ai)
                    </button>
                </div>

                <!-- NEW: Power Automate Section -->
                <div class="power-automate-section">
                    <h3>‚ö° Power Automate Export</h3>
                    <p>Generate ready-to-import Power Automate flows based on your integration scope</p>
                    <button id="paExportBtn" class="pa-export-btn" onclick="exportPowerAutomateFlow()" disabled>
                        üì• Export Power Automate Flow JSON
                    </button>
                </div>
            </div>

            <!-- Right Panel: Analysis & Flows -->
            <div>
                <div id="analysisPanel" class="analysis-section" style="display: none;">
                    <div class="section-header">üìä Analysis Results</div>
                    
                    <div id="detectedInfo" class="analysis-grid"></div>
                    
                    <div id="integrationPoints" class="analysis-grid"></div>

                    <div id="missingInfo" class="missing-info" style="display: none;">
                        <h4>‚ö†Ô∏è Missing Information</h4>
                        <ul id="missingList"></ul>
                    </div>

                    <!-- NEW: Power Automate Flow Preview -->
                    <div id="paFlowPreview" class="pa-flow-preview">
                        <h3>‚ö° Detected Power Automate Opportunities</h3>
                        <div id="paFlowSteps" class="pa-flow-steps"></div>
                    </div>

                    <div class="section-header" style="margin-top: 32px;">üîÑ Integration Workflow</div>
                    
                    <div class="flow-grid">
                        <div class="flow-column">
                            <div class="column-header">Customer ‚Üí System</div>
                            <div id="flowCustomerToSystem"></div>
                        </div>
                        
                        <div class="flow-column">
                            <div class="column-header">System ‚Üí Customer</div>
                            <div id="flowSystemToCustomer"></div>
                        </div>
                        
                        <div class="flow-column">
                            <div class="column-header">Inbound (Receiving)</div>
                            <div id="flowOrdersInbound"></div>
                        </div>
                        
                        <div class="flow-column">
                            <div class="column-header">Outbound (Fulfillment)</div>
                            <div id="flowOrdersOutbound"></div>
                        </div>
                    </div>

                    <div id="exportPanel" class="export-panel">
                        <button class="export-btn" style="background: #3b82f6; color: white;" onclick="exportJSON()">üíæ Export JSON</button>
                        <button class="export-btn" style="background: #10b981; color: white;" onclick="exportMarkdown()">üìÑ Export Markdown</button>
                        <button class="export-btn" style="background: #8b5cf6; color: white;" onclick="generateQuestions()">‚ùì Generate Follow-up Questions</button>
                        <button class="export-btn" style="background: #0078d4; color: white;" onclick="exportPowerAutomateFlow()">‚ö° Export PA Flow</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let flowData = {
            customerToSystem: [],
            systemToCustomer: [],
            ordersInbound: [],
            ordersOutbound: [],
            metadata: {},
            powerAutomateFlows: [] // NEW
        };

        // File upload handling
        const fileUploadZone = document.getElementById('fileUploadZone');
        const fileInput = document.getElementById('fileInput');

        fileUploadZone.addEventListener('click', () => fileInput.click());
        
        fileUploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadZone.classList.add('dragover');
        });

        fileUploadZone.addEventListener('dragleave', () => {
            fileUploadZone.classList.remove('dragover');
        });

        fileUploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            handleFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            handleFile(file);
        });

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('scopeInput').value = e.target.result;
                document.querySelector('.upload-text').innerHTML = 
                    `‚úÖ <strong>${file.name}</strong> loaded<br><small>Ready to analyze</small>`;
            };
            reader.readAsText(file);
        }

        // Main analysis function
        function analyzeScope() {
            const scopeText = document.getElementById('scopeInput').value.trim();
            
            if (!scopeText) {
                alert('Please enter or upload a scope document first!');
                return;
            }

            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Analyzing...';

            // Simulate AI processing
            setTimeout(() => {
                const analysis = parseScope(scopeText);
                displayAnalysis(analysis);
                generateFlows(analysis);
                detectPowerAutomateOpportunities(analysis); // NEW
                
                btn.disabled = false;
                btn.innerHTML = 'üîç Analyze & Generate Flow';
                
                document.getElementById('analyzeBtn').style.display = 'block';
                document.getElementById('analysisPanel').style.display = 'block';
                document.getElementById('exportPanel').style.display = 'flex';
                document.getElementById('paExportBtn').disabled = false;
            }, 1500);
        }

        // Enhanced parse scope with Power Automate detection
        function parseScope(text) {
            const lower = text.toLowerCase();
            
            const analysis = {
                systems: [],
                processes: [],
                frequencies: [],
                requirements: [],
                missing: [],
                automationOpportunities: [] // NEW
            };

            // Detect systems (Enhanced)
            const systemKeywords = {
                'shopify': 'Shopify',
                'shipstation': 'ShipStation',
                'machship': 'MachShip',
                'naviafill': 'NaviaFill 3PL',
                'navia fill': 'NaviaFill 3PL',
                'navia': 'Navia 3PL',
                'bgi': 'BGI Warehouse (CW1)',
                'cargowise': 'CargoWise',
                'cw1': 'CargoWise',
                'raft': 'Raft.ai',
                'raft.ai': 'Raft.ai',
                'cin7': 'Cin7',
                'odoo': 'Odoo ERP',
                'warehouse': 'WMS',
                'wms': 'WMS',
                'microsoft outlook': 'Outlook',
                'outlook': 'Outlook',
                'gmail': 'Gmail',
                'sharepoint': 'SharePoint',
                'planner': 'Microsoft Planner',
                'teams': 'Microsoft Teams'
            };

            Object.entries(systemKeywords).forEach(([keyword, name]) => {
                if (lower.includes(keyword) && !analysis.systems.includes(name)) {
                    analysis.systems.push(name);
                }
            });

            // Detect processes
            if (lower.includes('order') && lower.includes('paid')) {
                analysis.processes.push('Auto-assign paid orders to warehouse');
            }
            if (lower.includes('inventory') && lower.includes('sync')) {
                analysis.processes.push('Inventory synchronization');
            }
            if (lower.includes('serial number') || lower.includes('serial tracking')) {
                analysis.processes.push('Serial number capture & tracking');
                analysis.requirements.push('Serial number tracking required');
            }
            if (lower.includes('hs code') || lower.includes('hs-code') || lower.includes('harmonized')) {
                analysis.processes.push('HS code classification');
                analysis.requirements.push('Customs/HS code management');
            }
            if (lower.includes('cross-border') || lower.includes('international ship')) {
                analysis.processes.push('Cross-border compliance');
                analysis.requirements.push('Customs documentation required');
            }
            if (lower.includes('shipping') || lower.includes('tracking')) {
                analysis.processes.push('Shipping & tracking updates');
            }
            if (lower.includes('carrier calculated') || lower.includes('live rates')) {
                analysis.processes.push('Real-time carrier rate calculation');
                analysis.requirements.push('Carrier API integration needed');
            }
            if (lower.includes('multi-warehouse') || lower.includes('multiple warehouse')) {
                analysis.processes.push('Multi-warehouse fulfillment');
                analysis.requirements.push('Location-based order routing');
            }
            if (lower.includes('report')) {
                analysis.processes.push('Reporting requirements');
            }
            if (lower.includes('back order') || lower.includes('backorder')) {
                analysis.processes.push('Back order management');
            }

            // NEW: Detect Power Automate workflow opportunities
            if (lower.includes('email') && (lower.includes('parse') || lower.includes('monitor') || lower.includes('support'))) {
                analysis.processes.push('Email-based workflow automation');
                analysis.automationOpportunities.push({
                    type: 'email_processing',
                    title: 'Email Parser with AI',
                    trigger: 'When new email arrives',
                    description: 'Parse support emails and create structured tasks'
                });
            }

            if (lower.includes('bug') || (lower.includes('issue') && lower.includes('tracking'))) {
                analysis.processes.push('Bug/Issue tracking automation');
                analysis.automationOpportunities.push({
                    type: 'bug_tracking',
                    title: 'Bug Report Automation',
                    trigger: 'When email arrives with bug report',
                    description: 'Extract bug details with AI and create Planner tasks'
                });
            }

            if (lower.includes('webhook') || lower.includes('api')) {
                analysis.automationOpportunities.push({
                    type: 'webhook_handler',
                    title: 'Multi-System Webhook Handler',
                    trigger: 'HTTP request received',
                    description: 'Route webhooks to multiple systems in parallel'
                });
            }

            if (lower.includes('invoice') && (lower.includes('process') || lower.includes('extract'))) {
                analysis.automationOpportunities.push({
                    type: 'invoice_processing',
                    title: 'AI Invoice Data Extraction',
                    trigger: 'When invoice email arrives',
                    description: 'Extract invoice data with AI Builder and validate'
                });
            }

            // Detect frequencies
            if (lower.match(/\d+x\s*(daily|day)/)) {
                const match = lower.match(/(\d+)x\s*(daily|day)/);
                analysis.frequencies.push(`${match[1]} times per day`);
            }
            if (lower.includes('morning') && lower.includes('midday')) {
                analysis.frequencies.push('Morning, Midday, EOD updates');
            }
            if (lower.includes('real-time') || lower.includes('immediately')) {
                analysis.frequencies.push('Real-time processing');
            }

            // Check for missing critical info
            const criticalFields = [
                { keyword: 'api', field: 'API credentials/endpoints' },
                { keyword: 'authentication', field: 'Authentication method' },
                { keyword: 'webhook', field: 'Webhook URLs' },
                { keyword: 'error handling', field: 'Error handling procedures' },
                { keyword: 'sla', field: 'SLA requirements' },
                { keyword: 'data format', field: 'Data format specifications' }
            ];

            criticalFields.forEach(item => {
                if (!lower.includes(item.keyword)) {
                    analysis.missing.push(item.field);
                }
            });

            // Always flag these if not explicit
            if (!lower.includes('timing') && !lower.includes('frequency') && analysis.frequencies.length === 0) {
                analysis.missing.push('Update frequency/timing details');
            }
            if (!lower.includes('format') && !lower.includes('json') && !lower.includes('xml')) {
                analysis.missing.push('Data format (JSON/XML/EDI)');
            }

            return analysis;
        }

        // Display analysis results
        function displayAnalysis(analysis) {
            // Detected systems
            const detectedInfo = document.getElementById('detectedInfo');
            detectedInfo.innerHTML = `
                <div class="analysis-card">
                    <div class="card-label">Systems Detected</div>
                    <div class="card-value">${analysis.systems.length} system${analysis.systems.length !== 1 ? 's' : ''}</div>
                </div>
                <div class="analysis-card">
                    <div class="card-label">Processes Identified</div>
                    <div class="card-value">${analysis.processes.length} process${analysis.processes.length !== 1 ? 'es' : ''}</div>
                </div>
                <div class="analysis-card ${analysis.frequencies.length === 0 ? 'warning' : ''}">
                    <div class="card-label">Timing Info</div>
                    <div class="card-value">${analysis.frequencies.length || 'Not specified'}</div>
                </div>
                <div class="analysis-card ${analysis.missing.length > 0 ? 'error' : ''}">
                    <div class="card-label">Completeness</div>
                    <div class="card-value">${analysis.missing.length === 0 ? '‚úÖ Complete' : `‚ö†Ô∏è ${analysis.missing.length} gaps`}</div>
                </div>
                <div class="analysis-card" style="border-color: #0078d4; background: #eff6ff;">
                    <div class="card-label">PA Automations</div>
                    <div class="card-value" style="color: #0078d4;">${analysis.automationOpportunities.length}</div>
                </div>
            `;

            // Integration points
            const integrationPoints = document.getElementById('integrationPoints');
            integrationPoints.innerHTML = analysis.systems.map(sys => `
                <div class="analysis-card">
                    <div class="card-label">System</div>
                    <div class="card-value" style="font-size: 16px;">${sys}</div>
                </div>
            `).join('');

            // Missing information
            const missingList = document.getElementById('missingList');
            if (analysis.missing.length > 0) {
                missingList.innerHTML = analysis.missing.map(item => 
                    `<li>${item}</li>`
                ).join('');
                document.getElementById('missingInfo').style.display = 'block';
            } else {
                document.getElementById('missingInfo').style.display = 'none';
            }

            flowData.metadata = {
                systems: analysis.systems,
                processes: analysis.processes,
                missing: analysis.missing,
                automationOpportunities: analysis.automationOpportunities,
                analyzedAt: new Date().toISOString()
            };
        }

        // NEW: Detect and display Power Automate opportunities
        function detectPowerAutomateOpportunities(analysis) {
            const paPreview = document.getElementById('paFlowPreview');
            const paSteps = document.getElementById('paFlowSteps');
            
            if (analysis.automationOpportunities.length > 0) {
                paPreview.style.display = 'block';
                paSteps.innerHTML = analysis.automationOpportunities.map((opp, idx) => `
                    <div class="pa-flow-step">
                        <strong>${idx + 1}. ${opp.title}</strong><br>
                        Trigger: ${opp.trigger}<br>
                        ${opp.description}
                    </div>
                `).join('');
            } else {
                paPreview.style.display = 'none';
            }
        }

        // Generate flow cards based on analysis
        function generateFlows(analysis) {
            const hasShopify = analysis.systems.some(s => s.includes('Shopify'));
            const hasWMS = analysis.systems.some(s => s.includes('WMS') || s.includes('3PL') || s.includes('BGI') || s.includes('NaviaFill'));
            const hasSerialNumbers = analysis.requirements.some(r => r.includes('Serial'));
            const hasShipStation = analysis.systems.some(s => s.includes('ShipStation'));
            const hasMachShip = analysis.systems.some(s => s.includes('MachShip'));

            // Customer to System flow
            flowData.customerToSystem = [
                {
                    stepNumber: 1,
                    title: hasShopify ? 'Customer Places Order (Shopify)' : 'Customer Places Order',
                    message: 'Order Create Event',
                    system: hasShopify ? 'Shopify' : 'E-commerce Platform',
                    timing: analysis.frequencies.includes('Real-time processing') ? 'Real-time' : 'TBD',
                    notes: 'Customer completes checkout. Payment confirmed.',
                    complete: hasShopify
                },
                {
                    stepNumber: 2,
                    title: 'Order Webhook/API Call',
                    message: 'Order JSON Payload',
                    system: 'Integration Layer',
                    timing: 'Real-time (<1 second)',
                    notes: analysis.missing.includes('Webhook URLs') ? 'MISSING: Webhook endpoint details' : 'Webhook endpoint captures order data',
                    complete: !analysis.missing.includes('Webhook URLs')
                },
                {
                    stepNumber: 3,
                    title: 'Order Validation',
                    message: 'Validated Order Data',
                    system: hasWMS ? analysis.systems.find(s => s.includes('3PL') || s.includes('Navia') || s.includes('BGI')) || 'WMS' : 'WMS',
                    timing: 'Real-time',
                    notes: 'Validate inventory, address, payment status',
                    complete: hasWMS
                },
                {
                    stepNumber: 4,
                    title: 'Create Pick Task',
                    message: 'Pick Order',
                    system: hasWMS ? analysis.systems.find(s => s.includes('3PL') || s.includes('Navia') || s.includes('BGI')) || 'WMS' : 'WMS',
                    timing: analysis.frequencies[0] || 'TBD - Specify batch frequency',
                    notes: 'Generate warehouse pick list',
                    complete: analysis.frequencies.length > 0
                }
            ];

            // System to Customer flow
            const shippingPlatform = hasShipStation ? 'ShipStation' : hasMachShip ? 'MachShip' : 'Shipping Platform';
            
            flowData.systemToCustomer = [
                {
                    stepNumber: 1,
                    title: 'Pick Complete',
                    message: 'Pick Confirmation',
                    system: hasWMS ? analysis.systems.find(s => s.includes('3PL') || s.includes('Navia') || s.includes('BGI')) || 'WMS' : 'WMS',
                    timing: 'Real-time',
                    notes: 'Items picked and moved to pack station',
                    complete: true
                },
                {
                    stepNumber: 2,
                    title: 'Pack & Generate Label',
                    message: 'Pack Confirmation + Tracking',
                    system: shippingPlatform,
                    timing: 'Real-time',
                    notes: analysis.missing.includes('Shipping carrier integration') ? 'MISSING: Carrier details' : `Generate shipping label via ${shippingPlatform}`,
                    complete: hasShipStation || hasMachShip
                },
                {
                    stepNumber: 3,
                    title: 'Update Order Status',
                    message: 'Fulfillment Update',
                    system: hasShopify ? 'Shopify API' : 'E-commerce Platform',
                    timing: 'Real-time',
                    notes: 'Push tracking number back to store',
                    complete: hasShopify
                },
                {
                    stepNumber: 4,
                    title: 'Customer Notification',
                    message: 'Shipping Notification Email',
                    system: hasShopify ? 'Shopify' : 'E-commerce Platform',
                    timing: 'Real-time',
                    notes: 'Customer receives tracking information',
                    complete: true
                }
            ];

            // Inbound flow
            flowData.ordersInbound = [
                {
                    stepNumber: 1,
                    title: hasSerialNumbers ? 'Receive Goods with Serial Capture' : 'Receive Goods',
                    message: 'Receipt Confirmation',
                    system: hasWMS ? analysis.systems.find(s => s.includes('3PL') || s.includes('Navia') || s.includes('BGI')) || 'WMS' : 'WMS',
                    timing: 'Real-time (on arrival)',
                    notes: hasSerialNumbers ? 'Capture serial numbers during receiving process' : 'Physical receipt at warehouse dock',
                    complete: hasWMS
                },
                {
                    stepNumber: 2,
                    title: 'Quality Check',
                    message: 'QC Pass/Fail',
                    system: hasWMS ? analysis.systems.find(s => s.includes('3PL') || s.includes('Navia') || s.includes('BGI')) || 'WMS' : 'WMS',
                    timing: 'Within 2 hours',
                    notes: 'Inspect for damage, verify quantities',
                    complete: true
                },
                {
                    stepNumber: 3,
                    title: 'Putaway to Storage',
                    message: 'Putaway Complete',
                    system: hasWMS ? analysis.systems.find(s => s.includes('3PL') || s.includes('Navia') || s.includes('BGI')) || 'WMS' : 'WMS',
                    timing: 'Same day',
                    notes: 'Move goods to designated storage locations',
                    complete: true
                },
                {
                    stepNumber: 4,
                    title: 'Inventory Sync',
                    message: 'Inventory Update',
                    system: hasShopify ? 'WMS ‚Üí Shopify' : 'WMS ‚Üí E-commerce',
                    timing: analysis.frequencies[0] || 'TBD - Specify sync frequency',
                    notes: analysis.frequencies[0] || 'MISSING: Sync frequency (hourly/daily/real-time)',
                    complete: analysis.frequencies.length > 0
                }
            ];

            // Outbound flow
            flowData.ordersOutbound = [
                {
                    stepNumber: 1,
                    title: 'Pick from Storage',
                    message: 'Pick List',
                    system: hasWMS ? analysis.systems.find(s => s.includes('3PL') || s.includes('Navia') || s.includes('BGI')) || 'WMS' : 'WMS',
                    timing: 'Batch (wave picking)',
                    notes: 'Retrieve items based on pick path optimization',
                    complete: true
                },
                {
                    stepNumber: 2,
                    title: 'Pack & Label',
                    message: 'Pack Confirmation',
                    system: hasWMS ? analysis.systems.find(s => s.includes('3PL') || s.includes('Navia') || s.includes('BGI')) || 'WMS' : 'WMS',
                    timing: 'Real-time',
                    notes: 'Apply shipping label, record weight/dimensions',
                    complete: true
                },
                {
                    stepNumber: 3,
                    title: 'Stage for Dispatch',
                    message: 'Ready for Pickup',
                    system: hasWMS ? analysis.systems.find(s => s.includes('3PL') || s.includes('Navia') || s.includes('BGI')) || 'WMS' : 'WMS',
                    timing: 'Batch (by carrier)',
                    notes: 'Group by carrier for pickup',
                    complete: true
                },
                {
                    stepNumber: 4,
                    title: 'Carrier Pickup & Scan',
                    message: 'Shipment Manifested',
                    system: shippingPlatform,
                    timing: 'Daily (carrier schedule)',
                    notes: 'Carrier scans packages and departs',
                    complete: true
                }
            ];

            // Render flows
            renderFlowColumn('flowCustomerToSystem', flowData.customerToSystem);
            renderFlowColumn('flowSystemToCustomer', flowData.systemToCustomer);
            renderFlowColumn('flowOrdersInbound', flowData.ordersInbound);
            renderFlowColumn('flowOrdersOutbound', flowData.ordersOutbound);
        }

        function renderFlowColumn(elementId, flows) {
            const element = document.getElementById(elementId);
            element.innerHTML = flows.map(flow => `
                <div class="flow-card ${!flow.complete ? 'incomplete' : ''}">
                    <div>
                        <span class="flow-step-number">${flow.stepNumber}</span>
                        <span class="flow-title" contenteditable="true">${flow.title}</span>
                    </div>
                    <div class="flow-meta">
                        <strong>System:</strong> ${flow.system}<br>
                        <strong>Timing:</strong> ${flow.timing}
                    </div>
                    <div class="flow-notes" contenteditable="true">${flow.notes}</div>
                </div>
            `).join('');
        }

        // Export functions
        function exportJSON() {
            const dataStr = JSON.stringify(flowData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `integration-flow-${Date.now()}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function exportMarkdown() {
            let markdown = `# Integration Flow Documentation\n\n`;
            markdown += `**Generated:** ${new Date().toLocaleString()}\n\n`;
            markdown += `## Systems Involved\n\n`;
            flowData.metadata.systems.forEach(sys => {
                markdown += `- ${sys}\n`;
            });
            markdown += `\n## Identified Processes\n\n`;
            flowData.metadata.processes.forEach(proc => {
                markdown += `- ${proc}\n`;
            });
            
            if (flowData.metadata.missing.length > 0) {
                markdown += `\n## ‚ö†Ô∏è Missing Information\n\n`;
                flowData.metadata.missing.forEach(item => {
                    markdown += `- [ ] ${item}\n`;
                });
            }

            markdown += `\n## Workflow: Customer ‚Üí System\n\n`;
            flowData.customerToSystem.forEach(step => {
                markdown += `### ${step.stepNumber}. ${step.title}\n`;
                markdown += `- **System:** ${step.system}\n`;
                markdown += `- **Timing:** ${step.timing}\n`;
                markdown += `- **Notes:** ${step.notes}\n\n`;
            });

            markdown += `\n## Workflow: System ‚Üí Customer\n\n`;
            flowData.systemToCustomer.forEach(step => {
                markdown += `### ${step.stepNumber}. ${step.title}\n`;
                markdown += `- **System:** ${step.system}\n`;
                markdown += `- **Timing:** ${step.timing}\n`;
                markdown += `- **Notes:** ${step.notes}\n\n`;
            });

            const blob = new Blob([markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `integration-flow-${Date.now()}.md`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function generateQuestions() {
            let questions = `# Follow-up Questions - Integration Scope\n\n`;
            questions += `**Generated:** ${new Date().toLocaleString()}\n\n`;
            questions += `## Missing Information\n\n`;
            
            if (flowData.metadata.missing.length > 0) {
                flowData.metadata.missing.forEach((item, idx) => {
                    questions += `${idx + 1}. ${item}\n`;
                });
            }

            questions += `\n## Additional Clarifications Needed\n\n`;
            questions += '1. What is your expected transaction volume (orders/day, shipments/day)?\n';
            questions += '2. What data format do you prefer (JSON, XML, EDI)?\n';
            questions += '3. Do you have existing API documentation?\n';
            questions += '4. What is your expected order volume (daily/monthly)?\n';
            questions += '5. Are there any compliance or regulatory requirements?\n';
            questions += '6. What error handling procedures should be implemented?\n';
            questions += '7. Do you need real-time updates or are batch processes acceptable?\n';

            const blob = new Blob([questions], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `follow-up-questions-${Date.now()}.md`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // NEW: Export Power Automate Flow
        function exportPowerAutomateFlow() {
            const opportunities = flowData.metadata.automationOpportunities;
            
            if (!opportunities || opportunities.length === 0) {
                alert('No Power Automate opportunities detected in this scope.\n\nTry adding keywords like:\n- Email parsing\n- Bug tracking\n- Invoice processing\n- Webhook handling');
                return;
            }

            // Generate flow based on detected opportunities
            const flowJson = generatePowerAutomateJSON(opportunities[0]);
            
            const dataStr = JSON.stringify(flowJson, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `power-automate-${opportunities[0].type}-${Date.now()}.json`;
            link.click();
            URL.revokeObjectURL(url);

            alert(`‚úÖ Power Automate flow exported!\n\nFlow Type: ${opportunities[0].title}\n\nTo import:\n1. Go to Power Automate\n2. Click "My flows" ‚Üí "Import"\n3. Upload the downloaded JSON file\n4. Configure connections as needed`);
        }

        // NEW: Generate Power Automate JSON based on opportunity type
        function generatePowerAutomateJSON(opportunity) {
            const flows = {
                email_processing: {
                    "name": "Email Parser with AI - NaviaFreight",
                    "properties": {
                        "definition": {
                            "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                            "contentVersion": "1.0.0.0",
                            "parameters": {},
                            "triggers": {
                                "When_a_new_email_arrives_(V3)": {
                                    "type": "ApiConnectionNotification",
                                    "inputs": {
                                        "host": {
                                            "connection": {
                                                "name": "@parameters('$connections')['office365']['connectionId']"
                                            }
                                        },
                                        "fetch": {
                                            "method": "get",
                                            "pathTemplate": {
                                                "template": "/v3/Mail/OnNewEmail"
                                            },
                                            "queries": {
                                                "folderPath": "Inbox",
                                                "importance": "Any",
                                                "fetchOnlyWithAttachment": false,
                                                "includeAttachments": true
                                            }
                                        }
                                    }
                                }
                            },
                            "actions": {
                                "Initialize_CorrelationID": {
                                    "type": "InitializeVariable",
                                    "inputs": {
                                        "variables": [{
                                            "name": "CorrelationID",
                                            "type": "string",
                                            "value": "@{guid()}"
                                        }]
                                    }
                                },
                                "Compose_Clean_Email_Body": {
                                    "type": "Compose",
                                    "inputs": "@trim(triggerBody()?['body'])",
                                    "runAfter": {
                                        "Initialize_CorrelationID": ["Succeeded"]
                                    }
                                },
                                "HTTP_Azure_OpenAI": {
                                    "type": "Http",
                                    "inputs": {
                                        "method": "POST",
                                        "uri": "YOUR_AZURE_OPENAI_ENDPOINT",
                                        "headers": {
                                            "Content-Type": "application/json",
                                            "api-key": "YOUR_API_KEY"
                                        },
                                        "body": {
                                            "messages": [
                                                {
                                                    "role": "system",
                                                    "content": "Extract: title, description, priority (High/Medium/Low), category. Return JSON only."
                                                },
                                                {
                                                    "role": "user",
                                                    "content": "@{outputs('Compose_Clean_Email_Body')}"
                                                }
                                            ],
                                            "temperature": 0.3,
                                            "max_tokens": 1000
                                        }
                                    },
                                    "runAfter": {
                                        "Compose_Clean_Email_Body": ["Succeeded"]
                                    }
                                },
                                "Parse_AI_Response": {
                                    "type": "ParseJson",
                                    "inputs": {
                                        "content": "@body('HTTP_Azure_OpenAI')?['choices'][0]['message']['content']",
                                        "schema": {
                                            "type": "object",
                                            "properties": {
                                                "title": {"type": "string"},
                                                "description": {"type": "string"},
                                                "priority": {"type": "string"},
                                                "category": {"type": "string"}
                                            }
                                        }
                                    },
                                    "runAfter": {
                                        "HTTP_Azure_OpenAI": ["Succeeded"]
                                    }
                                },
                                "Create_SharePoint_Item": {
                                    "type": "ApiConnection",
                                    "inputs": {
                                        "host": {
                                            "connection": {
                                                "name": "@parameters('$connections')['sharepointonline']['connectionId']"
                                            }
                                        },
                                        "method": "post",
                                        "path": "/datasets/@{encodeURIComponent('YOUR_SITE')}/tables/@{encodeURIComponent('YOUR_LIST')}/items",
                                        "body": {
                                            "Title": "@body('Parse_AI_Response')?['title']",
                                            "Description": "@body('Parse_AI_Response')?['description']",
                                            "Priority": "@body('Parse_AI_Response')?['priority']",
                                            "Category": "@body('Parse_AI_Response')?['category']",
                                            "CorrelationID": "@variables('CorrelationID')"
                                        }
                                    },
                                    "runAfter": {
                                        "Parse_AI_Response": ["Succeeded"]
                                    }
                                },
                                "Send_Confirmation_Email": {
                                    "type": "ApiConnection",
                                    "inputs": {
                                        "host": {
                                            "connection": {
                                                "name": "@parameters('$connections')['office365']['connectionId']"
                                            }
                                        },
                                        "method": "post",
                                        "path": "/v2/Mail",
                                        "body": {
                                            "To": "@triggerBody()?['from']",
                                            "Subject": "Task Created: @{body('Parse_AI_Response')?['title']}",
                                            "Body": "<p>Your request has been logged.<br><br><strong>Task ID:</strong> @{variables('CorrelationID')}<br><strong>Priority:</strong> @{body('Parse_AI_Response')?['priority']}</p>"
                                        }
                                    },
                                    "runAfter": {
                                        "Create_SharePoint_Item": ["Succeeded"]
                                    }
                                }
                            }
                        }
                    }
                },
                bug_tracking: {
                    "name": "Bug Report Automation - NaviaFreight",
                    "properties": {
                        "definition": {
                            "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                            "contentVersion": "1.0.0.0",
                            "triggers": {
                                "When_email_arrives_bug_report": {
                                    "type": "ApiConnectionNotification",
                                    "inputs": {
                                        "host": {
                                            "connection": {
                                                "name": "@parameters('$connections')['office365']['connectionId']"
                                            }
                                        },
                                        "fetch": {
                                            "queries": {
                                                "subjectFilter": "bug,issue,error",
                                                "folderPath": "Inbox"
                                            }
                                        }
                                    }
                                }
                            },
                            "actions": {
                                "Create_Planner_Task": {
                                    "type": "ApiConnection",
                                    "inputs": {
                                        "host": {
                                            "connection": {
                                                "name": "@parameters('$connections')['planner']['connectionId']"
                                            }
                                        },
                                        "method": "post",
                                        "path": "/plans/@{encodeURIComponent('YOUR_PLAN_ID')}/tasks",
                                        "body": {
                                            "title": "Bug: @{triggerBody()?['subject']}",
                                            "assignments": {
                                                "YOUR_USER_ID": {
                                                    "@odata.type": "#microsoft.graph.plannerAssignment",
                                                    "orderHint": " !"
                                                }
                                            },
                                            "priority": 1
                                        }
                                    }
                                }
                            }
                        }
                    }
                },
                webhook_handler: {
                    "name": "Multi-System Webhook Handler - NaviaFreight",
                    "properties": {
                        "definition": {
                            "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                            "contentVersion": "1.0.0.0",
                            "triggers": {
                                "manual": {
                                    "type": "Request",
                                    "kind": "Http",
                                    "inputs": {
                                        "schema": {
                                            "type": "object",
                                            "properties": {
                                                "source": {"type": "string"},
                                                "event_type": {"type": "string"},
                                                "payload": {"type": "object"}
                                            }
                                        }
                                    }
                                }
                            },
                            "actions": {
                                "Response": {
                                    "type": "Response",
                                    "inputs": {
                                        "statusCode": 202,
                                        "body": {
                                            "status": "accepted",
                                            "message": "Event queued for processing"
                                        }
                                    }
                                },
                                "Parallel_System_Updates": {
                                    "type": "Scope",
                                    "actions": {
                                        "Update_CargoWise": {
                                            "type": "Http",
                                            "inputs": {
                                                "method": "POST",
                                                "uri": "YOUR_CARGOWISE_ENDPOINT",
                                                "body": "@triggerBody()"
                                            }
                                        },
                                        "Update_Shopify": {
                                            "type": "Http",
                                            "inputs": {
                                                "method": "POST",
                                                "uri": "YOUR_SHOPIFY_ENDPOINT",
                                                "body": "@triggerBody()"
                                            }
                                        }
                                    },
                                    "runAfter": {
                                        "Response": ["Succeeded"]
                                    }
                                }
                            }
                        }
                    }
                },
                invoice_processing: {
                    "name": "AI Invoice Processing - Raft.ai Integration",
                    "properties": {
                        "definition": {
                            "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                            "contentVersion": "1.0.0.0",
                            "triggers": {
                                "When_invoice_email_arrives": {
                                    "type": "ApiConnectionNotification",
                                    "inputs": {
                                        "host": {
                                            "connection": {
                                                "name": "@parameters('$connections')['office365']['connectionId']"
                                            }
                                        },
                                        "fetch": {
                                            "queries": {
                                                "subjectFilter": "invoice",
                                                "fetchOnlyWithAttachment": true
                                            }
                                        }
                                    }
                                }
                            },
                            "actions": {
                                "AI_Builder_Process_Invoice": {
                                    "type": "ApiConnection",
                                    "inputs": {
                                        "host": {
                                            "connection": {
                                                "name": "@parameters('$connections')['aibuilder']['connectionId']"
                                            }
                                        },
                                        "method": "post",
                                        "path": "/formrecognizer/YOUR_MODEL_ID",
                                        "body": {
                                            "file": "@triggerBody()?['attachments'][0]['contentBytes']"
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            };

            return flows[opportunity.type] || flows.email_processing;
        }

        // Quick Templates
        function loadShopifyNaviaTemplate() {
            const templateText = `Integration Scope: Shopify ‚Üí NaviaFill ‚Üí BGI Warehouse

Systems Involved:
- Shopify (e-commerce platform)
- NaviaFill (3PL middleware)
- BGI Warehouse (CargoWise WMS)
- ShipStation (shipping platform)

Order Flow:
1. Customer places order on Shopify
2. Order webhook triggers in real-time
3. NaviaFill receives order and validates inventory
4. Order pushed to BGI CargoWise WMS
5. BGI warehouse picks, packs, and ships
6. Tracking number returned via NaviaFill to Shopify
7. Customer receives shipping notification

Inventory Sync:
- Inventory synced from BGI ‚Üí Navia ‚Üí Shopify
- Frequency: Real-time updates for critical SKUs, batch 3x daily for others
- Serial number tracking required for high-value items

Shipping:
- ShipStation integration for carrier calculated rates
- Support for UPS, FedEx, USPS, DHL
- Auto-select packaging based on order dimensions
- Live checkout rates enabled

Requirements:
- API credentials for Shopify, BGI, ShipStation
- Webhook endpoints configured
- Serial number capture during receiving
- Multi-location routing (USA warehouse)
`;
            document.getElementById('scopeInput').value = templateText;
            analyzeScope();
        }

        function loadMultiWarehouseTemplate() {
            const templateText = `Integration Scope: Multi-Warehouse Global Fulfillment

Systems Involved:
- Shopify (global store)
- NaviaFill (3PL orchestration)
- USA Warehouse (Los Angeles - primary)
- AUS Warehouse (Melbourne - APAC)
- NL Warehouse (Amsterdam - EU)
- MachShip (AU/NZ shipping)
- ShipStation (USA/EU shipping)

Order Routing Logic:
1. Customer places order with shipping address
2. System determines closest warehouse with inventory
3. Order automatically routed to appropriate fulfillment center
4. Local carrier rates calculated based on destination

Inventory Management:
- Real-time inventory sync across all 3 locations
- Automatic reorder triggers when warehouse hits minimum stock
- Transfer orders between warehouses for stock balancing

Cross-Border Requirements:
- HS code classification for all products
- Customs documentation auto-generation
- Commercial invoices included with shipments
- Compliance with AQIS (Australia biosecurity)

Shipping Configuration:
- USA: FedEx, UPS, USPS via ShipStation
- AUS/NZ: Australia Post, StarTrack via MachShip  
- EU: DHL, DPD, PostNL via local carriers
`;
            document.getElementById('scopeInput').value = templateText;
            analyzeScope();
        }

        function loadCrossBorderTemplate() {
            const templateText = `Integration Scope: Cross-Border E-commerce with Compliance

Systems Involved:
- Shopify (international store)
- CargoWise (freight forwarding platform)
- Raft.ai (customs document processing)
- NaviaFill (fulfillment middleware)

Order Processing:
1. International order placed (outside domestic market)
2. System checks for HS code classification
3. Auto-generate commercial invoice
4. Create customs declaration
5. Submit to customs broker if value > threshold

Compliance Requirements:
- HS code: Required for all products
- Country of origin: Mandatory field
- Product description: Detailed (not just SKU)
- Value declaration: Accurate commercial value
- Restricted goods screening: Automatic flagging

Documentation:
- Commercial invoice (3 copies)
- Packing declaration
- Certificate of origin (when required)
- AQIS declaration (Australia bound)
- Biosecurity statements

Customs Processing:
- Automatic document generation
- Email alerts for manual review items
- Raft.ai parses broker communications
- Track customs clearance status
- Exception handling for inspections/delays

Shipping Options:
- Express International: DHL, FedEx, UPS
- Standard International: National postal services
- Freight: For bulk orders (>30kg)
- DDP (Delivered Duty Paid) vs DDU options
`;
            document.getElementById('scopeInput').value = templateText;
            analyzeScope();
        }

        // NEW: Email Bug Tracking Template
        function loadEmailBugTrackingTemplate() {
            const templateText = `Integration Scope: Email Bug Tracking with Raft.ai

Systems Involved:
- Microsoft Outlook (email platform)
- Raft.ai (AI email processing)
- Microsoft Planner (task management)
- SharePoint (bug tracking database)

Workflow:
1. Support emails arrive at support@naviafreight.com
2. Email parsing triggers Power Automate flow
3. AI extracts bug details:
   - Title/summary
   - Description
   - Priority (High/Medium/Low)
   - Affected system
   - Steps to reproduce
   - Reporter contact

4. Validation checks:
   - Required fields present
   - Priority assigned correctly
   - System identified

5. Create tracking records:
   - Planner task assigned to dev team
   - SharePoint list entry for audit trail
   - Unique bug ID generated

6. Notifications:
   - Confirmation email to reporter
   - Slack alert to dev channel
   - Teams notification for high priority

Error Handling:
- If parsing fails ‚Üí Manual review queue
- If validation fails ‚Üí Admin notification
- All errors logged to error table

Reporting:
- Daily bug count summary
- Priority distribution metrics
- Average resolution time tracking
`;
            document.getElementById('scopeInput').value = templateText;
            analyzeScope();
        }
    </script>
</body>
</html>